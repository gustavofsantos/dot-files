#!/bin/bash
if [[ "$1" == "--help" ]]; then
    echo "COMMAND: cdd-archive <track-name>"
    echo "OBJECTIVE: Move completed track to history and promote knowledge."
    echo "CONSTRAINT: Cannot archive if there are pending tasks ([ ])."
    exit 0
fi
TRACK_NAME=$1
SRC=".context/tracks/$TRACK_NAME"
PLAN_FILE="$SRC/plan.md"
SPEC_FILE="$SRC/spec.md"
UPDATE_FILE="$SRC/context_updates.md"
DEST=".context/archive/$(date +%Y%m%d)_$TRACK_NAME"
FEATURE_DEST=".context/features/$TRACK_NAME.md"

if [ ! -d "$SRC" ]; then
    echo "Error: Track '$TRACK_NAME' not found."
    exit 1
fi

# Validation: Check for unchecked items
if [ -f "$PLAN_FILE" ]; then
    if grep -q "\[ \]" "$PLAN_FILE"; then
        echo "Error: Cannot archive '$TRACK_NAME'. Pending tasks found in plan.md."
        exit 1
    fi
fi

# 1. Promote Spec to Living Documentation
if [ -f "$SPEC_FILE" ]; then
    cp "$SPEC_FILE" "$FEATURE_DEST"
    echo "âœ… Promoted spec to Living Docs: $FEATURE_DEST"
fi

# 2. Handle Context Updates (Inbox Pattern)
if [ -f "$UPDATE_FILE" ] && [ -s "$UPDATE_FILE" ]; then
    # Check if file has content other than the header
    LINE_COUNT=$(wc -l < "$UPDATE_FILE")
    if [ "$LINE_COUNT" -gt 2 ]; then
        echo -e "\n\n## Updates from Track: $TRACK_NAME ($(date))" >> .context/inbox.md
        cat "$UPDATE_FILE" >> .context/inbox.md
        echo "âœ… Appended context updates to .context/inbox.md"
    fi
fi

# 3. Archive
mv "$SRC" "$DEST"
echo "ðŸ“¦ Archived workspace to '$DEST'"
