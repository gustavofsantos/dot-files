#!/usr/bin/env bash

set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

MODE="default"
INCLUDE_UNTRACKED=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --staged)
            MODE="staged"
            shift
            ;;
        --working)
            MODE="working"
            shift
            ;;
        --branch)
            MODE="branch"
            shift
            ;;
        --with-untracked)
            INCLUDE_UNTRACKED=true
            shift
            ;;
        --help|-h)
            cat <<EOF
Usage: git-changed-files [MODE] [OPTIONS]

Modes:
  --staged   List staged files (git diff --cached)
  --working  List modified working files (git diff)
  --branch   List files changed in current branch compared to main branch
  (default)  List both staged and modified files

Options:
  --with-untracked  Include untracked files
  -h, --help        Show this help message
EOF
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'"
            echo ""
            exec "$0" --help
            ;;
    esac
done

# Get changed files based on the selected mode
case "$MODE" in
    "staged")
        all_changed_files=$(git diff --name-only --cached 2>/dev/null || true)
        ;;
    "working")
        all_changed_files=$(git diff --name-only 2>/dev/null || true)
        ;;
    "branch")
        main_branch=$("$SCRIPT_DIR/git-main-branch")
        all_changed_files=$(git diff --name-only "$main_branch"...HEAD 2>/dev/null || true)
        ;;
    "default")
        staged_files=$(git diff --name-only --cached 2>/dev/null || true)
        modified_files=$(git diff --name-only 2>/dev/null || true)
        all_changed_files=$(echo -e "$staged_files\n$modified_files" | sort -u | grep -v '^$')
        ;;
esac

untracked_files=""
if [ "$INCLUDE_UNTRACKED" = true ]; then
    untracked_files=$(git ls-files --others --exclude-standard 2>/dev/null || true)
fi

all_changed_files=$(echo -e "$all_changed_files\n$untracked_files" | sort -u | grep -v '^$' || true)

# Output the files
echo "$all_changed_files"
