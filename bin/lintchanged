#!/usr/bin/env bash

set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ $# -gt 0 ]; then
    case "$1" in
        --help|-h)
            cat <<EOF
Usage: lintchanged [MODE]

Modes:
  --staged   Lint staged files
  --working  Lint modified working files
  --branch   Lint files changed in current branch compared to main branch
  (default)  Lint both staged and modified files

Options:
  -h, --help  Show this help message
EOF
            exit 0
            ;;
    esac
fi

# Get changed files
all_changed_files=$("$SCRIPT_DIR/git-changed-files" "$@")

if [ -z "$all_changed_files" ]; then
    exit 0
fi

# Convert test files to array
mapfile -t files_array <<< "$all_changed_files"

# Run lint against each file
exit_code=0
for file_item in "${files_array[@]}"; do
    if [ -n "$file_item" ]; then
        # Capture lint output
        lint_output=$("$SCRIPT_DIR/lint" "$file_item" 2>&1)
        lint_result=$?
        
        if [ $lint_result -ne 0 ]; then
            # Only print if there's an error
            echo "$lint_output"
            exit_code=1
        fi
    fi
done

exit $exit_code
