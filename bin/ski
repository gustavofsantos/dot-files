#!/bin/bash

# skills-install: Symlink agent skills to various AI coding tools
# Usage: skills-install --target <tool> [--dry-run]
# Targets: cursor, claude-code, gemini-cli, amp, all

set -e

SKILLS_SOURCE="$HOME/.dot-files/agents/skills"
DRY_RUN=false
TARGET=""

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print with color
info() { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; }

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --target)
      TARGET="$2"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --help)
      echo "Usage: skills-install --target <tool> [--dry-run]"
      echo ""
      echo "Targets:"
      echo "  cursor      - Cursor IDE"
      echo "  claude-code - Claude Code (VS Code extension)"
      echo "  gemini-cli  - Google Gemini CLI"
      echo "  amp         - Amp AI coding agent"
      echo "  all         - Install to all targets"
      echo ""
      echo "Options:"
      echo "  --dry-run   - Show what would be done without making changes"
      echo "  --help      - Show this help message"
      exit 0
      ;;
    *)
      error "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Validate target
if [[ -z "$TARGET" ]]; then
  error "No target specified. Use --target <tool>"
  exit 1
fi

# Validate skills source exists
if [[ ! -d "$SKILLS_SOURCE" ]]; then
  error "Skills source directory not found: $SKILLS_SOURCE"
  exit 1
fi

# Create symlinks
create_symlink() {
  local skill_name=$1
  local target_dir=$2
  local skill_source="$SKILLS_SOURCE/$skill_name"
  local skill_link="$target_dir/$skill_name"

  if [[ ! -d "$skill_source" ]]; then
    warn "Skill not found: $skill_name"
    return
  fi

  # Create target directory if it doesn't exist
  if [[ ! -d "$target_dir" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
      info "[DRY RUN] mkdir -p $target_dir"
    else
      mkdir -p "$target_dir"
      info "Created directory: $target_dir"
    fi
  fi

  # Remove existing symlink or warn about existing file
  if [[ -L "$skill_link" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
      info "[DRY RUN] Removing existing symlink: $skill_link"
    else
      rm "$skill_link"
      info "Removed existing symlink: $skill_link"
    fi
  elif [[ -e "$skill_link" ]]; then
    warn "File exists and is not a symlink, skipping: $skill_link"
    return
  fi

  # Create symlink
  if [[ "$DRY_RUN" == true ]]; then
    info "[DRY RUN] ln -s $skill_source $skill_link"
  else
    ln -s "$skill_source" "$skill_link"
    success "Symlinked: $skill_name -> $skill_link"
  fi
}

# Get all skill names
get_skills() {
  if [[ ! -d "$SKILLS_SOURCE" ]]; then
    return
  fi
  find "$SKILLS_SOURCE" -maxdepth 1 -type d ! -name '.*' -exec basename {} \; | sort
}

# Install to Cursor
install_cursor() {
  local target_dir="$HOME/.cursor/skills"
  info "Installing to Cursor: $target_dir"
  
  for skill in $(get_skills); do
    create_symlink "$skill" "$target_dir"
  done
}

# Install to Claude Code
install_claude_code() {
  local target_dir="$HOME/.claude/skills"
  info "Installing to Claude Code: $target_dir"
  
  for skill in $(get_skills); do
    create_symlink "$skill" "$target_dir"
  done
}

# Install to Gemini CLI
install_gemini_cli() {
  local target_dir="$HOME/.gemini/skills"
  info "Installing to Gemini CLI: $target_dir"
  
  for skill in $(get_skills); do
    create_symlink "$skill" "$target_dir"
  done
}

# Install to Amp
install_amp() {
  local target_dir="$HOME/.config/agents/skills"
  info "Installing to Amp: $target_dir"
  
  for skill in $(get_skills); do
    create_symlink "$skill" "$target_dir"
  done
}

# Main
if [[ "$DRY_RUN" == true ]]; then
  info "Running in DRY RUN mode - no changes will be made"
fi

case "$TARGET" in
  cursor)
    install_cursor
    ;;
  claude-code)
    install_claude_code
    ;;
  gemini-cli)
    install_gemini_cli
    ;;
  amp)
    install_amp
    ;;
  all)
    install_cursor
    install_claude_code
    install_gemini_cli
    install_amp
    ;;
  *)
    error "Unknown target: $TARGET"
    exit 1
    ;;
esac

success "Installation complete!"
