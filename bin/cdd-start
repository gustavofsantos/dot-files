#!/bin/bash
if [[ "$1" == "--help" ]]; then
    echo "COMMAND: cdd-start <track-name>"
    echo "OBJECTIVE: Create an isolated workspace (Track)."
    echo "RATIONALE: Isolates context so multiple agents/tasks don't collide."
    exit 0
fi

TRACK_NAME=$1
if [ -z "$TRACK_NAME" ]; then echo "Error: Missing track name."; exit 1; fi
TRACK_DIR=".context/tracks/$TRACK_NAME"

if [ -d "$TRACK_DIR" ]; then echo "Error: Track exists."; exit 1; fi

mkdir -p "$TRACK_DIR"

# Generate Structured Spec Template
cat << SPEC > "$TRACK_DIR/spec.md"
# Specification: $TRACK_NAME

## 1. User Intent (The Goal)
> [User Input Required]

## 2. Relevant Context (The Files)
> [Agent to Populate during Analysis]
- \`path/to/relevant/file.ext\`

## 3. Context Analysis (Agent Findings)
> [Agent to Populate]
> - Current Behavior:
> - Proposed Changes:

## 4. Scenarios (Acceptance Criteria)
> [Agent to Draft based on Intent - Gherkin Style Preferred]
> Feature: $TRACK_NAME
>   Scenario: Happy Path
>     Given ...
>     When ...
>     Then ...
SPEC

# Context Updates Staging File
echo "# Proposed Global Context Updates" > "$TRACK_DIR/context_updates.md"
echo "> Add notes here if product.md or tech-stack.md needs updating." >> "$TRACK_DIR/context_updates.md"

cat << PLAN > "$TRACK_DIR/plan.md"
# Plan for $TRACK_NAME

- [ ] üó£Ô∏è Phase 0: Alignment & Analysis (Fill spec.md)
- [ ] üìù Phase 1: Approval (User signs off)
PLAN

cat << DECISION_LOG > "$TRACK_DIR/decisions.md"
# Decision Log
> Created $(date)
DECISION_LOG

cat << SCRATCHPAD > "$TRACK_DIR/scratchpad.md"
# Scratchpad for $TRACK_NAME
# > Dump raw logs here.
SCRATCHPAD

echo "Track '$TRACK_NAME' initialized."
