#!/bin/bash

# Usage: git-add-worktree <worktree-name> [<base-branch>]

REPO_DIR=$(git rev-parse --show-toplevel)
WORKSPACE_DIR=$(dirname "$REPO_DIR")
PROJECT_NAME=$(basename "$REPO_DIR")
WORKTREE_PARENT="$WORKSPACE_DIR/${PROJECT_NAME}-worktrees"

mkdir -p "$WORKTREE_PARENT"

WORKTREE_NAME="$1"
BASE_BRANCH="${2:-HEAD}"
WORKTREE_PATH="$WORKTREE_PARENT/$WORKTREE_NAME"

# Check if worktree path is empty or does not exist
if [ -e "$WORKTREE_PATH" ] && [ "$(ls -A "$WORKTREE_PATH")" ]; then
    echo "Error: Directory $WORKTREE_PATH exists and is not empty. Aborting."
    exit 1
fi

# Create the new worktree
if [ "$BASE_BRANCH" = "HEAD" ]; then
    git worktree add -b "$WORKTREE_NAME" "$WORKTREE_PATH"
else
    git worktree add -b "$WORKTREE_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"
fi

# Helper function to symlink a source to a target
symlink_if_needed() {
    local source="$1"
    local target="$2"
    local source_type="$3"  # "dir" or "file"

    # Check if source exists
    if [ "$source_type" = "dir" ] && [ ! -d "$source" ]; then
        return
    elif [ "$source_type" = "file" ] && [ ! -f "$source" ]; then
        return
    fi

    # If target already exists, skip
    if [ -e "$target" ]; then
        echo "Info: $target already exists; skipping symlink."
        return
    fi

    ln -s "$source" "$target"
    echo "Symlinked $(basename "$source") from $REPO_DIR to $WORKTREE_PATH"
}

# Symlink shared resources from main repo
symlink_if_needed "$REPO_DIR/.cursor" "$WORKTREE_PATH/.cursor" "dir"
symlink_if_needed "$REPO_DIR/.claude" "$WORKTREE_PATH/.claude" "dir"
symlink_if_needed "$REPO_DIR/.context" "$WORKTREE_PATH/.context" "dir"
symlink_if_needed "$REPO_DIR/.agents" "$WORKTREE_PATH/.agents" "dir"
symlink_if_needed "$REPO_DIR/AGENTS.md" "$WORKTREE_PATH/AGENTS.md" "file"
symlink_if_needed "$REPO_DIR/AGENTS.md" "$WORKTREE_PATH/CLAUDE.md" "file"

# Output the worktree path for the parent shell to use
echo "$WORKTREE_PATH"
