#!/bin/bash

# Usage: git-add-worktree <worktree-name> [<base-branch>]

REPO_DIR=$(git rev-parse --show-toplevel)
WORKSPACE_DIR=$(dirname "$REPO_DIR")
PROJECT_NAME=$(basename "$REPO_DIR")
WORKTREE_PARENT="$WORKSPACE_DIR/${PROJECT_NAME}-worktrees"

mkdir -p "$WORKTREE_PARENT"

WORKTREE_NAME="$1"
BASE_BRANCH="${2:-HEAD}"

WORKTREE_PATH="$WORKTREE_PARENT/$WORKTREE_NAME"

# Check if worktree path is empty or does not exist
if [ -e "$WORKTREE_PATH" ] && [ "$(ls -A "$WORKTREE_PATH")" ]; then
    echo "Error: Directory $WORKTREE_PATH exists and is not empty. Aborting."
    exit 1
fi

# Create the new worktree
if [ "$BASE_BRANCH" = "HEAD" ]; then
    git worktree add -b "$WORKTREE_NAME" "$WORKTREE_PATH"
else
    git worktree add -b "$WORKTREE_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"
fi

# If the main repo has a .cursor directory, symlink it into the new worktree
if [ -d "$REPO_DIR/.cursor" ]; then
    if [ -e "$WORKTREE_PATH/.cursor" ]; then
        echo "Info: $WORKTREE_PATH/.cursor already exists; skipping symlink."
    else
        ln -s "$REPO_DIR/.cursor" "$WORKTREE_PATH/.cursor"
        echo "Symlinked .cursor from $REPO_DIR to $WORKTREE_PATH"
    fi
fi


# If the main repo has a .gemini directory, symlink it into the new worktree
if [ -d "$REPO_DIR/.gemini" ]; then
    if [ -e "$WORKTREE_PATH/.gemini" ]; then
        echo "Info: $WORKTREE_PATH/.gemini already exists; skipping symlink."
    else
        ln -s "$REPO_DIR/.gemini" "$WORKTREE_PATH/.gemini"
        echo "Symlinked .gemini from $REPO_DIR to $WORKTREE_PATH"
    fi
fi


# If the main repo has an AGENTS.md file, symlink it into the new worktree
if [ -f "$REPO_DIR/AGENTS.md" ]; then
    if [ -e "$WORKTREE_PATH/AGENTS.md" ]; then
        echo "Info: $WORKTREE_PATH/AGENTS.md already exists; skipping symlink."
    else
        ln -s "$REPO_DIR/AGENTS.md" "$WORKTREE_PATH/AGENTS.md"
        echo "Symlinked AGENTS.md from $REPO_DIR to $WORKTREE_PATH"
    fi
fi

# If the main repo has an AGENTS.md file, symlink it into the new worktree as CLAUDE.md
if [ -f "$REPO_DIR/AGENTS.md" ]; then
    if [ -e "$WORKTREE_PATH/CLAUDE.md" ]; then
        echo "Info: $WORKTREE_PATH/CLAUDE.md already exists; skipping symlink."
    else
        ln -s "$REPO_DIR/AGENTS.md" "$WORKTREE_PATH/CLAUDE.md"
        echo "Symlinked AGENTS.md from $REPO_DIR to $WORKTREE_PATH/CLAUDE.md"
    fi
fi

# Output the worktree path for the parent shell to use
echo "$WORKTREE_PATH"
