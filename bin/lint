#!/bin/bash

current_dir="$PWD"

# Check if input is coming from stdin or as an argument
if [ -t 0 ]; then
    # No stdin, use argument mode
    if [ "$#" -ne 1 ]; then
        echo "Usage:"
        echo "lint <relative_path>"
        echo "or"
        echo "git-changed-files [MODE] | lint"
        exit 1
    fi
    
    # Check if current directory matches the seubarriga workspace pattern
    if [[ "$current_dir" == *"/Workplace/seubarriga"* ]]; then
        # Check if the file is a clojure file
        if [[ "$1" =~ \.(clj|cljs|cljc)$ ]]; then
            echo "Running clj-kondo linter on Clojure file '$1' in: $current_dir"
            lint_command="clj-kondo --fail-level error --config ./.clj-kondo/config.edn --lint $1"
            eval "$lint_command"
            exit $?
        else
            # Not a Clojure file, exit with code 0 (success)
            echo "Skipping non-Clojure file: $1"
            exit 0
        fi
    else
        echo "No linter configured for current directory: $current_dir"
        exit 1
    fi
else
    # Read from stdin
    if [[ "$current_dir" == *"/Workplace/seubarriga"* ]]; then
        exit_code=0
        
        while IFS= read -r lint_path; do
            if [ -z "$lint_path" ]; then
                continue
            fi
            
            # Check if the file is a clojure file
            if [[ "$lint_path" =~ \.(clj|cljs|cljc)$ ]]; then
                echo "Running clj-kondo linter on Clojure file '$lint_path' in: $current_dir"
                lint_command="clj-kondo --fail-level error --config ./.clj-kondo/config.edn --lint $lint_path"
                eval "$lint_command"
                
                if [ $? -ne 0 ]; then
                    exit_code=1
                fi
            else
                # Not a Clojure file, skip it
                echo "Skipping non-Clojure file: $lint_path"
            fi
        done
        
        exit $exit_code
    else
        echo "No linter configured for current directory: $current_dir"
        exit 1
    fi
fi

echo "No linter configured for current directory: $current_dir"
exit 1
